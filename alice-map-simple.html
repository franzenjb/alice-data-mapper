<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALICE Data Map - All States</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        
        #map { 
            position: absolute;
            top: 60px;
            left: 0;
            width: 100%;
            height: calc(100vh - 60px);
            z-index: 1;
        }
        
        .header {
            height: 60px;
            background: #ED1B2E;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            margin-right: 20px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .stat-item {
            font-size: 14px;
        }
        
        .controls {
            position: absolute;
            top: 80px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            width: 300px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .control-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, sans-serif;
            background: white;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        
        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }
        
        .legend {
            line-height: 18px;
            color: #555;
        }
        
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ALICE Data Map</h1>
        <div class="stats">
            <div class="stat-item" id="total-states">Loading...</div>
            <div class="stat-item" id="total-counties">Loading...</div>
            <div class="stat-item" id="total-records">Loading...</div>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div class="controls">
        <div class="control-group">
            <label for="state-select">Select State:</label>
            <select id="state-select">
                <option value="">All States</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="metric-select">Display Metric:</label>
            <select id="metric-select">
                <option value="combined">ALICE + Poverty Rate</option>
                <option value="alice">ALICE Rate Only</option>
                <option value="poverty">Poverty Rate Only</option>
            </select>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        let map;
        let aliceData = [];
        let countyLayer;
        let info;
        let legend;
        let currentMetric = 'combined';
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([39.8283, -98.5795], 4);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add info control
            info = L.control();
            info.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'info');
                this.update();
                return this._div;
            };
            
            info.update = function (props) {
                this._div.innerHTML = '<h4>ALICE Data</h4>' + (props ?
                    '<b>' + props.county + ', ' + props.state + '</b><br />' +
                    'Poverty Rate: ' + props.povertyRate + '%<br />' +
                    'ALICE Rate: ' + props.aliceRate + '%<br />' +
                    'Combined: ' + props.combinedRate + '%<br />' +
                    'Total Households: ' + props.totalHouseholds.toLocaleString()
                    : 'Hover over a county');
            };
            
            info.addTo(map);
            
            // Add legend
            legend = L.control({position: 'bottomright'});
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend');
                const grades = [0, 10, 20, 30, 40, 50, 60, 70];
                const colors = ['#FFEDA0', '#FED976', '#FEB24C', '#FD8D3C', 
                               '#FC4E2A', '#E31A1C', '#BD0026', '#800026'];
                
                div.innerHTML = '<h4>Rate (%)</h4>';
                for (let i = 0; i < grades.length; i++) {
                    div.innerHTML +=
                        '<i style="background:' + colors[i] + '"></i> ' +
                        grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
                }
                return div;
            };
            legend.addTo(map);
        }
        
        // Load ALICE data
        async function loadData() {
            try {
                const response = await fetch('alice_master_database.json');
                aliceData = await response.json();
                
                // Filter to county-level data
                const countyData = aliceData.filter(d => d.geoLevel === 'county');
                
                // Get unique states
                const states = [...new Set(countyData.map(d => d.state))].sort();
                
                // Update stats
                document.getElementById('total-states').textContent = `${states.length} States`;
                document.getElementById('total-counties').textContent = `${countyData.length} Counties`;
                document.getElementById('total-records').textContent = `${aliceData.length} Total Records`;
                
                // Populate state dropdown
                const stateSelect = document.getElementById('state-select');
                states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    stateSelect.appendChild(option);
                });
                
                // Load county boundaries and display
                await loadCountyBoundaries();
                displayCounties();
                
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        // Load county boundaries
        async function loadCountyBoundaries() {
            const response = await fetch('https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json');
            const geoData = await response.json();
            
            // Create lookup map
            const dataByFips = new Map();
            aliceData.filter(d => d.geoLevel === 'county').forEach(d => {
                if (d.geoID) {
                    dataByFips.set(d.geoID.padStart(5, '0'), d);
                }
            });
            
            // Add data to features
            geoData.features = geoData.features.map(feature => {
                const fips = feature.id || feature.properties.STATE + feature.properties.COUNTY;
                const data = dataByFips.get(fips);
                if (data) {
                    feature.properties = { ...feature.properties, ...data };
                }
                return feature;
            }).filter(f => f.properties.state); // Only show counties with data
            
            // Create layer
            countyLayer = L.geoJSON(geoData, {
                style: style,
                onEachFeature: onEachFeature
            });
        }
        
        // Style function
        function style(feature) {
            return {
                fillColor: getColor(getMetricValue(feature.properties)),
                weight: 0.5,
                opacity: 1,
                color: 'white',
                fillOpacity: 0.7
            };
        }
        
        // Get metric value
        function getMetricValue(props) {
            if (!props) return 0;
            switch(currentMetric) {
                case 'alice': return parseFloat(props.aliceRate) || 0;
                case 'poverty': return parseFloat(props.povertyRate) || 0;
                case 'combined': return parseFloat(props.combinedRate) || 0;
                default: return 0;
            }
        }
        
        // Get color based on value
        function getColor(d) {
            return d > 70 ? '#800026' :
                   d > 60 ? '#BD0026' :
                   d > 50 ? '#E31A1C' :
                   d > 40 ? '#FC4E2A' :
                   d > 30 ? '#FD8D3C' :
                   d > 20 ? '#FEB24C' :
                   d > 10 ? '#FED976' :
                            '#FFEDA0';
        }
        
        // Feature interaction
        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: zoomToFeature
            });
        }
        
        function highlightFeature(e) {
            const layer = e.target;
            layer.setStyle({
                weight: 3,
                color: '#666',
                fillOpacity: 0.9
            });
            layer.bringToFront();
            info.update(layer.feature.properties);
        }
        
        function resetHighlight(e) {
            countyLayer.resetStyle(e.target);
            info.update();
        }
        
        function zoomToFeature(e) {
            map.fitBounds(e.target.getBounds());
        }
        
        // Display counties
        function displayCounties(stateFilter = '') {
            if (countyLayer) {
                map.removeLayer(countyLayer);
            }
            
            if (stateFilter) {
                const filtered = {
                    type: 'FeatureCollection',
                    features: countyLayer.toGeoJSON().features.filter(f => 
                        f.properties.state === stateFilter
                    )
                };
                
                const filteredLayer = L.geoJSON(filtered, {
                    style: style,
                    onEachFeature: onEachFeature
                });
                
                filteredLayer.addTo(map);
                map.fitBounds(filteredLayer.getBounds());
            } else {
                countyLayer.addTo(map);
            }
        }
        
        // Event listeners
        document.getElementById('state-select').addEventListener('change', (e) => {
            displayCounties(e.target.value);
        });
        
        document.getElementById('metric-select').addEventListener('change', (e) => {
            currentMetric = e.target.value;
            if (countyLayer) {
                countyLayer.setStyle(style);
            }
        });
        
        // Initialize
        initMap();
        loadData();
    </script>
</body>
</html>