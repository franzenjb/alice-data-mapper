<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALICE Data Map - Red Cross Integrated</title>
    
    <!-- ArcGIS CSS -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    
    <!-- Chart.js for trend graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        html, body {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        #viewDiv {
            height: 100%;
            width: 100%;
        }
        
        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-screen.hidden {
            display: none;
        }
        
        .loading-content {
            text-align: center;
            padding: 40px;
        }
        
        .redcross-logo {
            width: 80px;
            height: 80px;
            background: #ED1B2E;
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ED1B2E;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-message {
            margin: 20px 0;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .status-message.info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #90caf9;
        }
        
        .status-message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #81c784;
        }
        
        .status-message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef5350;
        }
        
        .login-prompt {
            margin-top: 30px;
        }
        
        .login-btn {
            background: #ED1B2E;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .login-btn:hover {
            background: #C41E3A;
        }
        
        .user-info {
            position: absolute;
            top: 15px;
            left: 15px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            display: none;
        }
        
        .user-info.active {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-info .redcross-badge {
            background: #ED1B2E;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .logout-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .control-panel {
            position: absolute;
            top: 15px;
            right: 15px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            display: none;
        }
        
        .control-panel.active {
            display: block;
        }
        
        h2 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.4em;
        }
        
        .info-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }
        
        .stat-label {
            color: #666;
        }
        
        .stat-value {
            font-weight: bold;
            color: #333;
        }
        
        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            position: absolute;
            bottom: 20px;
            left: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
        }
        
        .legend.active {
            display: block;
        }
    </style>
</head>
<body>
    <div id="viewDiv"></div>
    
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="redcross-logo">+</div>
            <h1>ALICE Data Explorer</h1>
            <p>American Red Cross Edition</p>
            
            <div class="loading-spinner"></div>
            
            <div class="status-message info" id="statusMessage">
                Checking authentication status...
            </div>
            
            <div class="login-prompt" id="loginPrompt" style="display: none;">
                <button class="login-btn" onclick="initiateLogin()">
                    Sign In with Red Cross Account
                </button>
            </div>
        </div>
    </div>
    
    <!-- User Info -->
    <div class="user-info" id="userInfo">
        <span class="redcross-badge">RED CROSS</span>
        <span id="userName">Loading...</span>
        <button class="logout-btn" onclick="handleLogout()">Sign Out</button>
    </div>
    
    <!-- Control Panel -->
    <div class="control-panel" id="controlPanel">
        <h2>ALICE Data Explorer</h2>
        <!-- Controls here -->
    </div>
    
    <!-- Legend -->
    <div class="legend" id="legend">
        <div class="legend-title">ALICE + Poverty Rate</div>
        <!-- Legend items here -->
    </div>
    
    <!-- ArcGIS JavaScript API -->
    <script src="https://js.arcgis.com/4.28/"></script>
    
    <script>
        let esriId, OAuthInfo, Portal;
        let aliceData = [];
        let currentYear = 2023;
        let map, view;
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            initializeAuth();
        });
        
        function initializeAuth() {
            require([
                "esri/identity/OAuthInfo",
                "esri/identity/IdentityManager",
                "esri/portal/Portal"
            ], function(OAuth, IdentityManager, PortalClass) {
                OAuthInfo = OAuth;
                esriId = IdentityManager;
                Portal = PortalClass;
                
                // Register Red Cross portal
                const redcrossInfo = new OAuthInfo({
                    appId: "arcgisonline",
                    portalUrl: "https://arc-nhq-gis.maps.arcgis.com",
                    popup: false, // Use redirect instead of popup
                    flowType: "authorization-code",
                    popupCallbackUrl: window.location.href // Return to this page
                });
                
                esriId.registerOAuthInfos([redcrossInfo]);
                
                // Check if returning from login
                if (window.location.hash && window.location.hash.includes("access_token")) {
                    handleOAuthCallback();
                } else {
                    // Check if already authenticated
                    checkAuthentication();
                }
            });
        }
        
        function checkAuthentication() {
            updateStatus("Checking Red Cross portal authentication...");
            
            esriId.checkSignInStatus("https://arc-nhq-gis.maps.arcgis.com/sharing")
                .then(function(credential) {
                    updateStatus("Authentication verified!", "success");
                    loadPortal();
                })
                .catch(function() {
                    // Not authenticated
                    updateStatus("Please sign in with your Red Cross account", "info");
                    document.getElementById('loginPrompt').style.display = 'block';
                });
        }
        
        function initiateLogin() {
            updateStatus("Redirecting to Red Cross login...", "info");
            
            // This will redirect to the Red Cross portal login
            esriId.getCredential("https://arc-nhq-gis.maps.arcgis.com/sharing", {
                oAuthPopupConfirmation: false
            }).then(function(credential) {
                updateStatus("Login successful!", "success");
                loadPortal();
            }).catch(function(error) {
                updateStatus("Login failed. Please try again.", "error");
                console.error("Login error:", error);
            });
        }
        
        function handleOAuthCallback() {
            // Process OAuth return
            updateStatus("Processing authentication...", "info");
            
            try {
                // Parse the OAuth response from the URL
                const hash = window.location.hash.substring(1);
                const params = new URLSearchParams(hash);
                
                if (params.get('access_token')) {
                    updateStatus("Authentication successful!", "success");
                    
                    // Clear the hash from URL
                    window.history.replaceState(null, null, window.location.pathname);
                    
                    // Load portal
                    setTimeout(loadPortal, 1000);
                } else if (params.get('error')) {
                    updateStatus("Authentication failed: " + params.get('error'), "error");
                    document.getElementById('loginPrompt').style.display = 'block';
                }
            } catch (error) {
                console.error("OAuth callback error:", error);
                checkAuthentication();
            }
        }
        
        function loadPortal() {
            const portal = new Portal("https://arc-nhq-gis.maps.arcgis.com");
            portal.authMode = "immediate";
            
            portal.load().then(function() {
                // Hide loading screen
                document.getElementById('loadingScreen').className = 'loading-screen hidden';
                
                // Show user info
                const userInfo = document.getElementById('userInfo');
                userInfo.className = 'user-info active';
                document.getElementById('userName').textContent = portal.user.username;
                
                // Show controls
                document.getElementById('controlPanel').className = 'control-panel active';
                document.getElementById('legend').className = 'legend active';
                
                // Initialize map
                initializeMap();
            }).catch(function(error) {
                console.error("Portal load error:", error);
                updateStatus("Failed to load portal. Please try logging in again.", "error");
                document.getElementById('loginPrompt').style.display = 'block';
            });
        }
        
        function initializeMap() {
            require([
                "esri/Map",
                "esri/views/MapView",
                "esri/layers/FeatureLayer",
                "esri/layers/GraphicsLayer"
            ], function(Map, MapView, FeatureLayer, GraphicsLayer) {
                
                // Create map
                map = new Map({
                    basemap: "gray-vector"
                });
                
                // Create view
                view = new MapView({
                    container: "viewDiv",
                    map: map,
                    center: [-95, 39],
                    zoom: 4
                });
                
                // Load ALICE data
                loadAliceData();
            });
        }
        
        async function loadAliceData() {
            try {
                const response = await fetch('alice_master_database.json');
                aliceData = await response.json();
                console.log(`Loaded ${aliceData.length} ALICE records`);
                
                // Initialize map layers with data
                // ... (rest of map initialization)
            } catch (error) {
                console.error('Error loading ALICE data:', error);
            }
        }
        
        function handleLogout() {
            esriId.destroyCredentials();
            window.location.reload();
        }
        
        function updateStatus(message, type = "info") {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
        }
    </script>
</body>
</html>