<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALICE Data Intelligence Dashboard - FAST</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #0f172a;
        }
        
        .header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 1rem 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo h1 {
            font-size: 1.25rem;
            color: #0f172a;
            font-weight: 700;
        }
        
        .logo .badge {
            background: #22c55e;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .stats {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0f172a;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #64748b;
        }
        
        .controls {
            background: white;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .controls-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .control-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
        }
        
        select, input[type="text"] {
            padding: 0.5rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background: white;
            min-width: 150px;
        }
        
        button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        button.primary {
            background: #3b82f6;
            color: white;
        }
        
        button.primary:hover {
            background: #2563eb;
        }
        
        button.secondary {
            background: white;
            color: #475569;
            border: 1px solid #e2e8f0;
        }
        
        button.secondary:hover {
            background: #f8fafc;
        }
        
        .main-content {
            max-width: 1400px;
            margin: 1rem auto;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            padding: 0 1rem;
        }
        
        .map-container {
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        
        #map {
            height: 600px;
            width: 100%;
        }
        
        .map-controls {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            z-index: 1000;
            display: flex;
            gap: 0.5rem;
        }
        
        .map-controls button {
            background: white;
            color: #475569;
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .map-controls button.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .panel {
            background: white;
            border-radius: 0.5rem;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .panel h2 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .metric {
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 0.375rem;
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }
        
        .metric-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0f172a;
        }
        
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .tab {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            color: #64748b;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }
        
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            font-size: 0.875rem;
        }
        
        th {
            text-align: left;
            padding: 0.5rem;
            background: #f8fafc;
            font-weight: 600;
            color: #475569;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 0.5rem;
            border-top: 1px solid #e2e8f0;
        }
        
        tr:hover {
            background: #f8fafc;
            cursor: pointer;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .popup-content {
            padding: 1rem;
        }
        
        .popup-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: #0f172a;
        }
        
        .popup-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .popup-stat {
            text-align: center;
        }
        
        .popup-stat-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }
        
        .popup-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .popup-change {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.75rem;
        }
        
        .popup-change.positive {
            color: #22c55e;
        }
        
        .popup-change.negative {
            color: #ef4444;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #64748b;
        }
        
        .export-options {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .export-options button {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.75rem;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            #map {
                height: 500px;
            }
        }
        
        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .legend h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <h1>ALICE Intelligence Dashboard</h1>
                <span class="badge">FAST</span>
            </div>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="totalRecords">0</div>
                    <div class="stat-label">records loaded</div>
                </div>
                <div class="stat">
                    <div class="stat-value">Updated: 9/20/2025</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="controls">
        <div class="controls-inner">
            <div class="control-group">
                <label class="control-label">Year</label>
                <select id="yearSelect">
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                    <option value="2021">2021</option>
                    <option value="2019">2019</option>
                    <option value="2018">2018</option>
                    <option value="2016">2016</option>
                    <option value="2014">2014</option>
                    <option value="2012">2012</option>
                    <option value="2010">2010</option>
                </select>
            </div>
            
            <div class="control-group">
                <label class="control-label">State</label>
                <select id="stateSelect">
                    <option value="">All States</option>
                </select>
            </div>
            
            <div class="control-group">
                <label class="control-label">County</label>
                <select id="countySelect" disabled>
                    <option value="">Select a state first</option>
                </select>
            </div>
            
            <div class="control-group">
                <label class="control-label">Search</label>
                <input type="text" id="searchInput" placeholder="Type county or state name..." />
            </div>
            
            <div class="control-group" style="margin-left: auto;">
                <label class="control-label">&nbsp;</label>
                <button class="secondary" onclick="resetFilters()">Reset</button>
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="map-container">
            <div id="map"></div>
            <div class="map-controls">
                <button class="active" data-view="combined">Combined</button>
                <button data-view="alice">ALICE Only</button>
                <button data-view="poverty">Poverty Only</button>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="panel">
                <h2>Key Metrics</h2>
                <div class="metrics-grid">
                    <div class="metric">
                        <div class="metric-label">Counties</div>
                        <div class="metric-value" id="countiesCount">0</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Avg Combined</div>
                        <div class="metric-value" id="avgCombined">0%</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Households</div>
                        <div class="metric-value" id="totalHouseholds">0</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Struggling</div>
                        <div class="metric-value" id="strugglingHouseholds">0</div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <div class="tabs">
                    <button class="tab active" data-tab="rankings">Rankings</button>
                    <button class="tab" data-tab="trends">Trends</button>
                </div>
                
                <div id="rankings" class="tab-content">
                    <div class="table-container">
                        <table id="rankingsTable">
                            <thead>
                                <tr>
                                    <th>County</th>
                                    <th>State</th>
                                    <th>ALICE</th>
                                    <th>Combined</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="trends" class="tab-content" style="display: none;">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
            
            <div class="panel">
                <h2>Export Options</h2>
                <div class="export-options">
                    <button class="secondary" onclick="exportCSV()">CSV</button>
                    <button class="secondary" onclick="exportJSON()">JSON</button>
                    <button class="secondary" onclick="exportReport()">Report</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let map;
        let countyLayer;
        let aliceData = [];
        let currentView = 'combined';
        let currentYear = 2023;
        let currentState = '';
        let currentCounty = '';
        let chart = null;
        
        // Performance optimization: Create lookups
        let dataByGeoID = new Map();
        let dataByStateYear = new Map();
        let countyLayersByFIPS = new Map();
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([39.8283, -98.5795], 4);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap © CARTO',
                maxZoom: 19
            }).addTo(map);
            
            // Add legend
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <h3>ALICE + Poverty Rate</h3>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #10b981"></div>
                        <span>0–10%</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fbbf24"></div>
                        <span>10–20%</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fb923c"></div>
                        <span>20–30%</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f87171"></div>
                        <span>30–40%</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ef4444"></div>
                        <span>40–50%</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #dc2626"></div>
                        <span>50+%</span>
                    </div>
                `;
                return div;
            };
            legend.addTo(map);
        }
        
        // Fast data loading with optimized lookups
        async function loadData() {
            try {
                // Load ALICE data
                const response = await fetch('alice_master_database.json');
                aliceData = await response.json();
                
                // Create optimized lookups for O(1) access
                console.time('Building lookups');
                aliceData.forEach(item => {
                    // Create GeoID + Year lookup
                    const key = `${item.geoID}_${item.year}`;
                    dataByGeoID.set(key, item);
                    
                    // Create State + Year lookup for aggregations
                    const stateKey = `${item.state}_${item.year}`;
                    if (!dataByStateYear.has(stateKey)) {
                        dataByStateYear.set(stateKey, []);
                    }
                    dataByStateYear.get(stateKey).push(item);
                });
                console.timeEnd('Building lookups');
                
                document.getElementById('totalRecords').textContent = aliceData.length.toLocaleString();
                
                // Populate states dropdown
                const states = [...new Set(aliceData.map(d => d.state))].sort();
                const stateSelect = document.getElementById('stateSelect');
                states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    stateSelect.appendChild(option);
                });
                
                // Initial view with limited data
                updateView();
                
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        // Optimized county loading with caching
        async function loadCountyBoundaries() {
            if (countyLayer) return; // Already loaded
            
            console.time('Loading counties');
            const response = await fetch('https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json');
            const geoData = await response.json();
            
            // Create county layer with optimized style function
            countyLayer = L.geoJSON(geoData, {
                style: feature => getCountyStyle(feature),
                onEachFeature: (feature, layer) => {
                    // Cache layers by FIPS for fast lookup
                    const fips = feature.properties.STATE + feature.properties.COUNTY;
                    countyLayersByFIPS.set(fips, layer);
                    
                    // Bind events
                    layer.on({
                        click: e => onCountyClick(e, layer, fips),
                        mouseover: e => onCountyHover(e, layer, fips),
                        mouseout: e => onCountyOut(e, layer, fips)
                    });
                }
            }).addTo(map);
            
            console.timeEnd('Loading counties');
        }
        
        // Optimized style function using cached data
        function getCountyStyle(feature) {
            const fips = feature.properties.STATE + feature.properties.COUNTY;
            const data = dataByGeoID.get(`${fips}_${currentYear}`);
            
            if (!data) {
                return {
                    fillColor: '#f0f0f0',
                    weight: 0.5,
                    opacity: 1,
                    color: '#ccc',
                    fillOpacity: 0.2
                };
            }
            
            const value = currentView === 'alice' ? data.aliceHouseholdPercent :
                          currentView === 'poverty' ? data.povertyHouseholdPercent :
                          data.combinedPercent;
            
            const color = value > 50 ? '#dc2626' :
                         value > 40 ? '#ef4444' :
                         value > 30 ? '#f87171' :
                         value > 20 ? '#fb923c' :
                         value > 10 ? '#fbbf24' :
                         '#10b981';
            
            return {
                fillColor: color,
                weight: 0.5,
                opacity: 1,
                color: '#white',
                fillOpacity: 0.7
            };
        }
        
        // Fast county click handler
        function onCountyClick(e, layer, fips) {
            const data = dataByGeoID.get(`${fips}_${currentYear}`);
            if (!data) return;
            
            // Update dropdowns
            document.getElementById('stateSelect').value = data.state;
            updateCountyDropdown(data.state);
            document.getElementById('countySelect').value = data.countyState;
            
            // Show popup
            showCountyPopup(layer, data);
            
            // Zoom to county
            map.fitBounds(layer.getBounds(), { padding: [50, 50], maxZoom: 10 });
            
            // Update sidebar
            updateSidebar([data]);
        }
        
        // Fast hover handlers
        function onCountyHover(e, layer, fips) {
            layer.setStyle({
                weight: 2,
                color: '#3b82f6'
            });
        }
        
        function onCountyOut(e, layer, fips) {
            layer.setStyle({
                weight: 0.5,
                color: 'white'
            });
        }
        
        // Show county popup
        function showCountyPopup(layer, data) {
            const prevYear = currentYear - 1;
            const prevData = dataByGeoID.get(`${data.geoID}_${prevYear}`);
            const change = prevData ? (data.combinedPercent - prevData.combinedPercent).toFixed(1) : null;
            
            const popupContent = `
                <div class="popup-content">
                    <div class="popup-title">${data.countyState}</div>
                    <div class="popup-stats">
                        <div class="popup-stat">
                            <div class="popup-stat-label">POVERTY</div>
                            <div class="popup-stat-value" style="color: #ef4444">
                                ${data.povertyHouseholdPercent.toFixed(1)}%
                            </div>
                        </div>
                        <div class="popup-stat">
                            <div class="popup-stat-label">ALICE</div>
                            <div class="popup-stat-value" style="color: #fbbf24">
                                ${data.aliceHouseholdPercent.toFixed(1)}%
                            </div>
                        </div>
                        <div class="popup-stat">
                            <div class="popup-stat-label">COMBINED</div>
                            <div class="popup-stat-value" style="color: #3b82f6">
                                ${data.combinedPercent.toFixed(1)}%
                            </div>
                        </div>
                    </div>
                    ${change ? `<div class="popup-change ${change > 0 ? 'negative' : 'positive'}">
                        ${change > 0 ? '+' : ''}${change}% from ${prevYear}
                    </div>` : ''}
                    <div class="popup-stat-label">
                        ${data.totalHouseholds.toLocaleString()} households
                    </div>
                </div>
            `;
            
            layer.bindPopup(popupContent).openPopup();
        }
        
        // Optimized view update
        function updateView() {
            console.time('Update view');
            
            // Get filtered data efficiently
            const filteredData = getFilteredData();
            
            // Update map styles if counties loaded
            if (countyLayer) {
                // Use requestAnimationFrame for smoother updates
                requestAnimationFrame(() => {
                    countyLayersByFIPS.forEach((layer, fips) => {
                        layer.setStyle(getCountyStyle(layer.feature));
                    });
                });
            } else {
                // Load counties if not already loaded
                loadCountyBoundaries();
            }
            
            // Update sidebar
            updateSidebar(filteredData);
            
            console.timeEnd('Update view');
        }
        
        // Fast data filtering
        function getFilteredData() {
            let filtered = [];
            
            if (currentState && currentCounty) {
                // Single county - O(1) lookup
                const data = dataByGeoID.get(`${currentCounty}_${currentYear}`);
                filtered = data ? [data] : [];
            } else if (currentState) {
                // State data - O(1) lookup
                filtered = dataByStateYear.get(`${currentState}_${currentYear}`) || [];
            } else {
                // All data for year - still optimized with filter
                filtered = aliceData.filter(d => d.year === currentYear && d.geoLevel === 'county');
            }
            
            return filtered;
        }
        
        // Update sidebar with data
        function updateSidebar(data) {
            // Update metrics
            const counties = data.length;
            const totalHH = data.reduce((sum, d) => sum + d.totalHouseholds, 0);
            const strugglingHH = data.reduce((sum, d) => sum + 
                (d.aliceHouseholds + d.povertyHouseholds), 0);
            const avgCombined = counties > 0 ? 
                data.reduce((sum, d) => sum + d.combinedPercent, 0) / counties : 0;
            
            document.getElementById('countiesCount').textContent = counties.toLocaleString();
            document.getElementById('avgCombined').textContent = avgCombined.toFixed(1) + '%';
            document.getElementById('totalHouseholds').textContent = 
                totalHH > 1000000 ? (totalHH / 1000000).toFixed(1) + 'M' : 
                totalHH > 1000 ? (totalHH / 1000).toFixed(0) + 'K' : 
                totalHH.toLocaleString();
            document.getElementById('strugglingHouseholds').textContent = 
                strugglingHH > 1000000 ? (strugglingHH / 1000000).toFixed(1) + 'M' : 
                strugglingHH > 1000 ? (strugglingHH / 1000).toFixed(0) + 'K' : 
                strugglingHH.toLocaleString();
            
            // Update rankings table - limit to top 20 for performance
            const sorted = [...data].sort((a, b) => b.combinedPercent - a.combinedPercent).slice(0, 20);
            const tbody = document.querySelector('#rankingsTable tbody');
            tbody.innerHTML = sorted.map(d => `
                <tr data-geoid="${d.geoID}" onclick="selectCounty('${d.geoID}')">
                    <td>${d.county}</td>
                    <td>${d.state}</td>
                    <td>${d.aliceHouseholdPercent.toFixed(1)}%</td>
                    <td><strong>${d.combinedPercent.toFixed(1)}%</strong></td>
                </tr>
            `).join('');
        }
        
        // Fast county selection
        function selectCounty(geoID) {
            const layer = countyLayersByFIPS.get(String(geoID));
            if (layer) {
                const data = dataByGeoID.get(`${geoID}_${currentYear}`);
                if (data) {
                    onCountyClick(null, layer, geoID);
                }
            }
        }
        
        // Update county dropdown
        function updateCountyDropdown(state) {
            const countySelect = document.getElementById('countySelect');
            
            if (!state) {
                countySelect.disabled = true;
                countySelect.innerHTML = '<option value="">Select a state first</option>';
                return;
            }
            
            countySelect.disabled = false;
            
            // Get unique counties for state
            const stateData = dataByStateYear.get(`${state}_${currentYear}`) || [];
            const counties = [...new Set(stateData.map(d => d.countyState))].sort();
            
            countySelect.innerHTML = '<option value="">All Counties</option>' +
                counties.map(c => {
                    const data = stateData.find(d => d.countyState === c);
                    return `<option value="${data.geoID}">${c}</option>`;
                }).join('');
        }
        
        // Search functionality with debounce
        let searchTimeout;
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = document.getElementById('searchInput').value.toLowerCase();
                if (query.length < 2) return;
                
                const matches = aliceData.filter(d => 
                    d.year === currentYear &&
                    d.geoLevel === 'county' &&
                    (d.county.toLowerCase().includes(query) || 
                     d.state.toLowerCase().includes(query))
                ).slice(0, 10); // Limit results
                
                if (matches.length > 0) {
                    selectCounty(matches[0].geoID);
                }
            }, 300);
        }
        
        // Reset filters
        function resetFilters() {
            currentYear = 2023;
            currentState = '';
            currentCounty = '';
            document.getElementById('yearSelect').value = '2023';
            document.getElementById('stateSelect').value = '';
            document.getElementById('countySelect').value = '';
            document.getElementById('searchInput').value = '';
            updateCountyDropdown('');
            updateView();
            map.setView([39.8283, -98.5795], 4);
        }
        
        // Export functions
        function exportCSV() {
            const data = getFilteredData();
            const csv = Papa.unparse(data);
            downloadFile(csv, 'alice-data.csv', 'text/csv');
        }
        
        function exportJSON() {
            const data = getFilteredData();
            const json = JSON.stringify(data, null, 2);
            downloadFile(json, 'alice-data.json', 'application/json');
        }
        
        function exportReport() {
            alert('Report generation coming soon!');
        }
        
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Event listeners
        document.getElementById('yearSelect').addEventListener('change', e => {
            currentYear = parseInt(e.target.value);
            updateView();
        });
        
        document.getElementById('stateSelect').addEventListener('change', e => {
            currentState = e.target.value;
            currentCounty = '';
            updateCountyDropdown(currentState);
            updateView();
            
            // Zoom to state if selected
            if (currentState && countyLayer) {
                const stateBounds = [];
                const stateData = dataByStateYear.get(`${currentState}_${currentYear}`) || [];
                stateData.forEach(d => {
                    const layer = countyLayersByFIPS.get(String(d.geoID));
                    if (layer) {
                        stateBounds.push(layer.getBounds());
                    }
                });
                if (stateBounds.length > 0) {
                    const bounds = L.latLngBounds(stateBounds);
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        });
        
        document.getElementById('countySelect').addEventListener('change', e => {
            currentCounty = e.target.value;
            if (currentCounty) {
                selectCounty(currentCounty);
            } else {
                updateView();
            }
        });
        
        document.getElementById('searchInput').addEventListener('input', handleSearch);
        
        // Map view buttons
        document.querySelectorAll('.map-controls button').forEach(btn => {
            btn.addEventListener('click', e => {
                document.querySelectorAll('.map-controls button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentView = btn.dataset.view;
                updateView();
            });
        });
        
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', e => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).style.display = 'block';
                
                if (tab.dataset.tab === 'trends' && !chart) {
                    initChart();
                }
            });
        });
        
        // Initialize trends chart
        function initChart() {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            const years = [2010, 2012, 2014, 2016, 2018, 2019, 2021, 2022, 2023];
            
            const chartData = years.map(year => {
                const data = currentState ? 
                    dataByStateYear.get(`${currentState}_${year}`) || [] :
                    aliceData.filter(d => d.year === year && d.geoLevel === 'county');
                
                const avg = data.length > 0 ?
                    data.reduce((sum, d) => sum + d.combinedPercent, 0) / data.length : 0;
                
                return avg;
            });
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Combined ALICE + Poverty %',
                        data: chartData,
                        borderColor: '#3b82f6',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        // Initialize on load
        initMap();
        loadData();
    </script>
</body>
</html>