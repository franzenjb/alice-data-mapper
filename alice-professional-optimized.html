<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALICE Data Intelligence Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #0f172a;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.3s;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loader {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #64748b;
            font-size: 0.875rem;
        }
        
        .header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 1rem 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .export-section {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
            padding-right: 1rem;
        }
        
        .export-btn-header {
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .export-btn-header:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo h1 {
            font-size: 1.25rem;
            color: #0f172a;
            font-weight: 700;
        }
        
        .logo .badge {
            background: #3b82f6;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .header-stats {
            display: flex;
            gap: 2rem;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.125rem;
            font-weight: 700;
            color: #0f172a;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        .controls {
            background: white;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .controls-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .control-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
        }
        
        select, input[type="text"] {
            padding: 0.5rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background: white;
            min-width: 150px;
        }
        
        .main-content {
            max-width: 1400px;
            margin: 1rem auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 0 1rem;
        }
        
        .map-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
        }
        
        .map-column {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .map-section {
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        
        #map {
            height: 450px;
            width: 100%;
        }
        
        .metrics-bar {
            background: white;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        .metrics-bar .metric {
            text-align: center;
            flex: 1;
            padding: 0 1rem;
            border-right: 1px solid #e5e7eb;
        }
        
        .metrics-bar .metric:last-child {
            border-right: none;
        }
        
        .metrics-bar .metric-label {
            font-size: 0.7rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.2rem;
        }
        
        .metrics-bar .metric-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #1f2937;
        }
        
        .poverty-metric .metric-label {
            color: #dc2626;
        }
        
        .poverty-metric .metric-value {
            color: #dc2626;
        }
        
        .alice-metric .metric-label {
            color: #f59e0b;
        }
        
        .alice-metric .metric-value {
            color: #f59e0b;
        }
        
        .combined-metric .metric-label {
            color: #3b82f6;
        }
        
        .combined-metric .metric-value {
            color: #3b82f6;
        }
        
        .map-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.4rem;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 0.4rem;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .map-legend {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.95);
            padding: 0.75rem;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }
        
        .legend-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.25rem 0;
        }
        
        .legend-color {
            width: 20px;
            height: 12px;
            border-radius: 2px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .legend-label {
            font-size: 0.7rem;
            color: #6b7280;
        }
        
        .view-button {
            padding: 0.5rem 0.9rem;
            background: white;
            color: #475569;
            border: 2px solid #e2e8f0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 75px;
        }
        
        .view-button:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }
        
        .view-button.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .panel {
            background: white;
            border-radius: 0.5rem;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .panel-header {
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .metric {
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 0.375rem;
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }
        
        .metric-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0f172a;
        }
        
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            font-size: 0.875rem;
        }
        
        th {
            text-align: left;
            padding: 0.5rem;
            background: #f8fafc;
            font-weight: 600;
            color: #475569;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 0.5rem;
            border-top: 1px solid #e2e8f0;
        }
        
        tr:hover {
            background: #f8fafc;
            cursor: pointer;
        }
        
        button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button.primary {
            background: #3b82f6;
            color: white;
        }
        
        button.primary:hover {
            background: #2563eb;
        }
        
        button.secondary {
            background: white;
            color: #475569;
            border: 1px solid #e2e8f0;
        }
        
        button.secondary:hover {
            background: #f8fafc;
        }
        
        .popup-content {
            padding: 0.5rem;
        }
        
        .popup-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .popup-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .popup-stat {
            text-align: center;
            padding: 0 4px;
        }
        
        .popup-stat-label {
            font-size: 0.625rem;
            color: #64748b;
        }
        
        .popup-stat-value {
            font-size: 1rem;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loader"></div>
        <div class="loading-text" id="loadingText">Loading ALICE data...</div>
    </div>

    <div class="header">
        <div class="header-content">
            <div class="logo">
                <h1>ALICE Intelligence Dashboard</h1>
                <span class="badge">OPTIMIZED</span>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <div class="stat-value" id="recordCount">0</div>
                    <div class="stat-label">records loaded</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">Updated: 9/20/2025</div>
                </div>
            </div>
            <div class="export-section">
                <button class="export-btn-header" onclick="exportCSV()">CSV</button>
                <button class="export-btn-header" onclick="exportJSON()">JSON</button>
            </div>
        </div>
    </div>
    
    <div class="controls">
        <div class="controls-inner">
            <div class="control-group">
                <label class="control-label">Year</label>
                <select id="yearSelect">
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                    <option value="2021">2021</option>
                    <option value="2019">2019</option>
                    <option value="2018">2018</option>
                </select>
            </div>
            
            <div class="control-group">
                <label class="control-label">State</label>
                <select id="stateSelect">
                    <option value="">All States</option>
                </select>
            </div>
            
            <div class="control-group">
                <label class="control-label">County</label>
                <select id="countySelect" disabled>
                    <option value="">Select a state first</option>
                </select>
            </div>
            
            <div class="control-group">
                <label class="control-label">Search</label>
                <input type="text" id="searchInput" placeholder="Type county name..." autocomplete="off" />
            </div>
            
            <div class="control-group" style="margin-left: auto;">
                <label class="control-label">&nbsp;</label>
                <button class="secondary" onclick="resetAll()">Reset</button>
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="map-row">
            <div class="map-column">
                <div class="map-section">
                    <div id="map"></div>
                    <div class="map-controls">
                        <button class="view-button active" data-view="combined">Combined</button>
                        <button class="view-button" data-view="alice">ALICE Only</button>
                        <button class="view-button" data-view="poverty">Poverty Only</button>
                    </div>
                    <div class="map-legend">
                        <div class="legend-title">Rate %</div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #10b981;"></span>
                            <span class="legend-label">0-10%</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #fbbf24;"></span>
                            <span class="legend-label">10-20%</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #fb923c;"></span>
                            <span class="legend-label">20-30%</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #f87171;"></span>
                            <span class="legend-label">30-40%</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ef4444;"></span>
                            <span class="legend-label">40-50%</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #dc2626;"></span>
                            <span class="legend-label">50%+</span>
                        </div>
                    </div>
                </div>
                <div class="metrics-bar">
                    <div class="metric">
                        <div class="metric-label">Counties</div>
                        <div class="metric-value" id="metricCounties">0</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Total Households</div>
                        <div class="metric-value" id="metricHouseholds">0</div>
                    </div>
                    <div class="metric poverty-metric">
                        <div class="metric-label">Poverty</div>
                        <div class="metric-value" id="metricPoverty">0% | 0</div>
                    </div>
                    <div class="metric alice-metric">
                        <div class="metric-label">ALICE</div>
                        <div class="metric-value" id="metricAlice">0% | 0</div>
                    </div>
                    <div class="metric combined-metric">
                        <div class="metric-label">Combined</div>
                        <div class="metric-value" id="metricCombined">0% | 0</div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="panel" id="trendPanel" style="display: none; overflow: hidden;">
                    <div class="panel-header">County Trends</div>
                    <div id="countyName" style="font-weight: bold; color: #1e293b; margin-bottom: 10px; font-size: 1.1rem;"></div>
                    <div style="position: relative; height: 200px; width: 100%; overflow: hidden;">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header" id="topCountiesHeader">Top Counties by Need</div>
                    <div class="table-container">
                        <table id="rankingsTable">
                            <thead>
                                <tr>
                                    <th>County</th>
                                    <th>State</th>
                                    <th>Combined</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let map;
        let countyLayer;
        let aliceData = [];
        let countyBoundaries = null;
        let currentView = 'combined';
        let currentYear = 2023;
        let currentState = '';
        let currentCounty = '';
        let dataCache = new Map();
        let searchTimeout;
        let isLoading = true;
        let selectedCountyLayer = null;
        let trendChart = null;
        
        // Performance: Cache data in localStorage
        const CACHE_KEY = 'alice_data_cache';
        const CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24 hours
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([39.8283, -98.5795], 4);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap © CARTO',
                maxZoom: 19
            }).addTo(map);
        }
        
        // Load data with caching
        async function loadData() {
            try {
                // Check cache first
                const cached = localStorage.getItem(CACHE_KEY);
                const cacheTime = localStorage.getItem(CACHE_KEY + '_time');
                
                if (cached && cacheTime && (Date.now() - parseInt(cacheTime) < CACHE_EXPIRY)) {
                    console.log('Using cached data');
                    aliceData = JSON.parse(cached);
                    document.getElementById('loadingText').textContent = 'Using cached data...';
                } else {
                    console.log('Fetching fresh data');
                    document.getElementById('loadingText').textContent = 'Downloading ALICE data...';
                    const response = await fetch('alice_master_database.json');
                    aliceData = await response.json();
                    
                    // Don't cache - too large for localStorage (85k records)
                    // localStorage causes quota exceeded error
                }
                
                // Build data cache for fast lookups
                aliceData.forEach(item => {
                    const key = `${item.geoID}_${item.year}`;
                    dataCache.set(key, item);
                });
                
                document.getElementById('recordCount').textContent = aliceData.length.toLocaleString();
                
                // Populate dropdowns
                populateDropdowns();
                
                // Load initial view (limited to top 20)
                updateView(true);
                
                // Lazy load county boundaries after initial render
                setTimeout(() => {
                    document.getElementById('loadingText').textContent = 'Loading map data...';
                    loadCountyBoundaries();
                }, 100);
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingText').textContent = 'Error loading data. Please refresh.';
            }
        }
        
        // Lazy load county boundaries
        async function loadCountyBoundaries() {
            if (countyLayer) return;
            
            try {
                const response = await fetch('https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json');
                countyBoundaries = await response.json();
                
                // Add to map with optimized rendering
                countyLayer = L.geoJSON(countyBoundaries, {
                    style: feature => getStyle(feature),
                    onEachFeature: (feature, layer) => {
                        layer.on({
                            click: e => onCountyClick(e, layer, feature)
                        });
                    }
                }).addTo(map);
                
                // Hide loading screen
                setTimeout(() => {
                    const loadingScreen = document.getElementById('loadingScreen');
                    if (loadingScreen) {
                        loadingScreen.style.display = 'none';
                    }
                    isLoading = false;
                }, 500);
                
            } catch (error) {
                console.error('Error loading county boundaries:', error);
                document.getElementById('loadingText').textContent = 'Map data unavailable. Data tables still work.';
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
                isLoading = false;
            }
        }
        
        // Get style for county
        function getStyle(feature) {
            const fips = feature.properties.STATE + feature.properties.COUNTY;
            const data = dataCache.get(`${fips}_${currentYear}`);
            
            // Hide counties not in selected state
            if (currentState && data && data.state !== currentState) {
                return {
                    fillColor: '#f0f0f0',
                    weight: 0.5,
                    opacity: 0.3,
                    color: 'white',
                    fillOpacity: 0.1
                };
            }
            
            if (!data) {
                return {
                    fillColor: '#f0f0f0',
                    weight: 0.5,
                    opacity: 1,
                    color: 'white',
                    fillOpacity: 0.2
                };
            }
            
            let value;
            if (currentView === 'alice') {
                value = parseFloat(data.aliceRate || 0);
            } else if (currentView === 'poverty') {
                value = parseFloat(data.povertyRate || 0);
            } else {
                value = parseFloat(data.combinedRate || 0);
            }
            
            const color = value > 50 ? '#dc2626' :
                         value > 40 ? '#ef4444' :
                         value > 30 ? '#f87171' :
                         value > 20 ? '#fb923c' :
                         value > 10 ? '#fbbf24' :
                         '#10b981';
            
            return {
                fillColor: color,
                weight: 0.5,
                opacity: 1,
                color: 'white',
                fillOpacity: 0.7
            };
        }
        
        // County click handler
        function onCountyClick(e, layer, feature) {
            const fips = feature.properties.STATE + feature.properties.COUNTY;
            const data = dataCache.get(`${fips}_${currentYear}`);
            
            if (!data) return;
            
            // Remove previous highlight
            if (selectedCountyLayer) {
                selectedCountyLayer.setStyle({
                    weight: 0.5,
                    color: 'white',
                    dashArray: ''
                });
            }
            
            // Add yellow highlight to selected county
            layer.setStyle({
                weight: 3,
                color: '#FFD700',
                dashArray: '',
                fillOpacity: 0.8
            });
            selectedCountyLayer = layer;
            
            // Create popup - always show all three values for context
            const popupContent = `
                <div class="popup-content">
                    <div class="popup-title">${data.county}, ${data.state}</div>
                    <div class="popup-stats">
                        <div class="popup-stat">
                            <div class="popup-stat-label">Poverty</div>
                            <div class="popup-stat-value" style="color: #ef4444">
                                ${parseFloat(data.povertyRate || 0).toFixed(1)}%
                            </div>
                            <div style="font-size: 0.65rem; color: #64748b;">
                                ${(data.povertyHouseholds || 0).toLocaleString()} HH
                            </div>
                        </div>
                        <div class="popup-stat">
                            <div class="popup-stat-label">ALICE</div>
                            <div class="popup-stat-value" style="color: #fbbf24">
                                ${parseFloat(data.aliceRate || 0).toFixed(1)}%
                            </div>
                            <div style="font-size: 0.65rem; color: #64748b;">
                                ${(data.aliceHouseholds || 0).toLocaleString()} HH
                            </div>
                        </div>
                        <div class="popup-stat">
                            <div class="popup-stat-label">Combined</div>
                            <div class="popup-stat-value" style="color: #3b82f6">
                                ${parseFloat(data.combinedRate || 0).toFixed(1)}%
                            </div>
                            <div style="font-size: 0.65rem; color: #64748b;">
                                ${((data.povertyHouseholds || 0) + (data.aliceHouseholds || 0)).toLocaleString()} HH
                            </div>
                        </div>
                    </div>
                    <div style="font-size: 0.75rem; color: #64748b; margin-top: 8px; border-top: 1px solid #e5e7eb; padding-top: 8px;">
                        Total: <strong style="color: #1f2937;">${(data.totalHouseholds || 0).toLocaleString()} households</strong>
                    </div>
                </div>
            `;
            
            layer.bindPopup(popupContent).openPopup();
            
            // Update dropdowns
            document.getElementById('stateSelect').value = data.state;
            updateCountyDropdown(data.state);
            
            // Update current state to filter top counties
            currentState = data.state;
            
            // Zoom to county
            map.fitBounds(layer.getBounds(), { padding: [50, 50], maxZoom: 10 });
            
            // Show trend chart
            showTrendChart(fips, data.county, data.state);
            
            // Update key metrics for selected county
            updateKeyMetricsForCounty(data);
            
            // Update the top counties table to show only this state
            const stateFiltered = aliceData.filter(d => 
                d.year === currentYear && 
                d.geoLevel === 'county' &&
                d.state === data.state
            );
            
            // Update table header to show the state
            document.getElementById('topCountiesHeader').textContent = 
                `Top Counties by Need - ${data.state}`;
            
            // Sort and update table
            const sorted = [...stateFiltered].sort((a, b) => 
                parseFloat(b.combinedRate || 0) - parseFloat(a.combinedRate || 0)
            );
            updateTable(sorted.slice(0, 20));
        }
        
        // Update key metrics for selected county
        function updateKeyMetricsForCounty(countyData) {
            document.getElementById('metricCounties').textContent = '1';
            document.getElementById('metricHouseholds').textContent = 
                (countyData.totalHouseholds || 0).toLocaleString();
            
            const povertyHH = countyData.povertyHouseholds || 0;
            const aliceHH = countyData.aliceHouseholds || 0;
            const combinedHH = povertyHH + aliceHH;
            
            const povertyRate = parseFloat(countyData.povertyRate || 0).toFixed(1);
            const aliceRate = parseFloat(countyData.aliceRate || 0).toFixed(1);
            const combinedRate = parseFloat(countyData.combinedRate || 0).toFixed(1);
            
            document.getElementById('metricPoverty').textContent = 
                `${povertyRate}% | ${povertyHH.toLocaleString()}`;
            document.getElementById('metricAlice').textContent = 
                `${aliceRate}% | ${aliceHH.toLocaleString()}`;
            document.getElementById('metricCombined').textContent = 
                `${combinedRate}% | ${combinedHH.toLocaleString()}`;
        }
        
        // Show trend chart for selected county
        function showTrendChart(fips, countyName, stateName) {
            // Get all years of data for this county
            const years = [2010, 2012, 2014, 2016, 2018, 2019, 2021, 2022, 2023];
            const povertyData = [];
            const aliceDataPoints = [];
            const combinedData = [];
            
            years.forEach(year => {
                const data = dataCache.get(`${fips}_${year}`);
                if (data) {
                    povertyData.push(parseFloat(data.povertyRate || 0));
                    aliceDataPoints.push(parseFloat(data.aliceRate || 0));
                    combinedData.push(parseFloat(data.combinedRate || 0));
                } else {
                    povertyData.push(null);
                    aliceDataPoints.push(null);
                    combinedData.push(null);
                }
            });
            
            // Find min and max values for dynamic Y-axis scaling
            const allValues = [...povertyData, ...aliceDataPoints, ...combinedData].filter(v => v !== null);
            const minValue = Math.min(...allValues);
            const maxValue = Math.max(...allValues);
            
            // Calculate Y-axis range with some padding
            const range = maxValue - minValue;
            const padding = range * 0.1; // 10% padding
            const yMin = Math.max(0, Math.floor(minValue - padding));
            const yMax = Math.min(100, Math.ceil(maxValue + padding));
            
            // Show the trend panel
            document.getElementById('trendPanel').style.display = 'block';
            document.getElementById('countyName').textContent = `${countyName}, ${stateName}`;
            
            // Destroy previous chart if exists
            if (trendChart) {
                trendChart.destroy();
                trendChart = null;
            }
            
            // Get canvas and ensure it's properly sized
            const canvas = document.getElementById('trendChart');
            const ctx = canvas.getContext('2d');
            
            // Create new chart
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Combined',
                            data: combinedData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.1
                        },
                        {
                            label: 'ALICE',
                            data: aliceDataPoints,
                            borderColor: '#fbbf24',
                            backgroundColor: 'rgba(251, 191, 36, 0.1)',
                            borderWidth: 2,
                            tension: 0.1
                        },
                        {
                            label: 'Poverty',
                            data: povertyData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            min: yMin,
                            max: yMax,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                stepSize: Math.ceil((yMax - yMin) / 5) // Aim for about 5 tick marks
                            }
                        }
                    }
                }
            });
        }
        
        // Populate dropdowns
        function populateDropdowns() {
            const states = [...new Set(aliceData.map(d => d.state))].sort();
            const stateSelect = document.getElementById('stateSelect');
            
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateSelect.appendChild(option);
            });
        }
        
        // Update county dropdown
        function updateCountyDropdown(state) {
            const countySelect = document.getElementById('countySelect');
            
            if (!state) {
                countySelect.disabled = true;
                countySelect.innerHTML = '<option value="">Select a state first</option>';
                return;
            }
            
            countySelect.disabled = false;
            // Get unique counties by geoID, showing only the most recent year's data for labels
            const countyMap = new Map();
            
            aliceData
                .filter(d => d.state === state && d.geoLevel === 'county')
                .sort((a, b) => b.year - a.year) // Sort by year descending to get most recent first
                .forEach(d => {
                    if (!countyMap.has(d.geoID)) {
                        countyMap.set(d.geoID, { 
                            name: d.county, 
                            id: d.geoID,
                            year: d.year 
                        });
                    }
                });
            
            const counties = Array.from(countyMap.values())
                .sort((a, b) => a.name.localeCompare(b.name));
            
            countySelect.innerHTML = '<option value="">All Counties</option>' +
                counties.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
        
        // Update view with limited data for performance
        function updateView(initial = false) {
            // Clear selection when updating view
            if (selectedCountyLayer) {
                selectedCountyLayer.setStyle({
                    weight: 0.5,
                    color: 'white',
                    dashArray: ''
                });
                selectedCountyLayer = null;
            }
            document.getElementById('trendPanel').style.display = 'none';
            
            // Filter data
            let filtered = aliceData.filter(d => 
                d.year === currentYear && 
                d.geoLevel === 'county' &&
                (!currentState || d.state === currentState) &&
                (!currentCounty || d.geoID === currentCounty)
            );
            
            // Update metrics
            updateMetrics(filtered);
            
            // Update table header based on state filter
            const headerText = currentState ? 
                `Top Counties by Need - ${currentState}` : 
                'Top Counties by Need';
            document.getElementById('topCountiesHeader').textContent = headerText;
            
            // Update table - sort by combined rate and show top 20
            const sortedFiltered = [...filtered].sort((a, b) => 
                parseFloat(b.combinedRate || 0) - parseFloat(a.combinedRate || 0)
            );
            updateTable(sortedFiltered.slice(0, 20));
            
            // Update map if loaded
            if (countyLayer && !initial) {
                requestAnimationFrame(() => {
                    countyLayer.eachLayer(layer => {
                        layer.setStyle(getStyle(layer.feature));
                    });
                });
            }
        }
        
        // Update metrics
        function updateMetrics(data) {
            const count = data.length;
            const totalHH = data.reduce((sum, d) => sum + (d.totalHouseholds || 0), 0);
            
            // Calculate totals and averages for each category
            const totalPovertyHH = data.reduce((sum, d) => sum + (d.povertyHouseholds || 0), 0);
            const totalAliceHH = data.reduce((sum, d) => sum + (d.aliceHouseholds || 0), 0);
            const totalCombinedHH = totalPovertyHH + totalAliceHH;
            
            const avgPoverty = count > 0 ? 
                data.reduce((sum, d) => sum + parseFloat(d.povertyRate || 0), 0) / count : 0;
            const avgAlice = count > 0 ? 
                data.reduce((sum, d) => sum + parseFloat(d.aliceRate || 0), 0) / count : 0;
            const avgCombined = count > 0 ? 
                data.reduce((sum, d) => sum + parseFloat(d.combinedRate || 0), 0) / count : 0;
            
            // Format household numbers
            const formatHH = (num) => num > 1000000 ? (num / 1000000).toFixed(1) + 'M' : Math.round(num).toLocaleString();
            
            document.getElementById('metricCounties').textContent = count.toLocaleString();
            document.getElementById('metricHouseholds').textContent = formatHH(totalHH);
            
            document.getElementById('metricPoverty').textContent = 
                `${avgPoverty.toFixed(1)}% | ${formatHH(totalPovertyHH)}`;
            document.getElementById('metricAlice').textContent = 
                `${avgAlice.toFixed(1)}% | ${formatHH(totalAliceHH)}`;
            document.getElementById('metricCombined').textContent = 
                `${avgCombined.toFixed(1)}% | ${formatHH(totalCombinedHH)}`;
        }
        
        // Update table
        function updateTable(data) {
            const sorted = [...data].sort((a, b) => 
                parseFloat(b.combinedRate || 0) - parseFloat(a.combinedRate || 0)
            );
            
            const tbody = document.querySelector('#rankingsTable tbody');
            tbody.innerHTML = sorted.map(d => `
                <tr onclick="selectCounty('${d.geoID}')" style="cursor: pointer;">
                    <td>${d.county}</td>
                    <td>${d.state}</td>
                    <td><strong>${parseFloat(d.combinedRate || 0).toFixed(1)}%</strong></td>
                </tr>
            `).join('');
        }
        
        // Select county
        function selectCounty(geoID) {
            const data = dataCache.get(`${geoID}_${currentYear}`);
            if (!data) return;
            
            currentCounty = geoID;
            currentState = data.state;
            
            // Update dropdowns
            document.getElementById('stateSelect').value = data.state;
            updateCountyDropdown(data.state);
            document.getElementById('countySelect').value = geoID;
            
            // Find and click county on map if loaded
            if (countyLayer) {
                countyLayer.eachLayer(layer => {
                    const fips = layer.feature.properties.STATE + layer.feature.properties.COUNTY;
                    if (fips === String(geoID)) {
                        layer.fire('click');
                    }
                });
            }
            
            updateView();
        }
        
        // Search with debounce
        function handleSearch(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value.toLowerCase();
            
            if (query.length < 2) return;
            
            searchTimeout = setTimeout(() => {
                const matches = aliceData.filter(d => 
                    d.year === currentYear &&
                    d.geoLevel === 'county' &&
                    d.county.toLowerCase().includes(query)
                ).slice(0, 5);
                
                if (matches.length > 0) {
                    selectCounty(matches[0].geoID);
                }
            }, 300);
        }
        
        // Reset all
        function resetAll() {
            currentYear = 2023;
            currentState = '';
            currentCounty = '';
            document.getElementById('yearSelect').value = '2023';
            document.getElementById('stateSelect').value = '';
            document.getElementById('countySelect').value = '';
            document.getElementById('searchInput').value = '';
            updateCountyDropdown('');
            updateView();
            map.setView([39.8283, -98.5795], 4);
        }
        
        // Export functions
        function exportCSV() {
            const filtered = aliceData.filter(d => 
                d.year === currentYear && 
                d.geoLevel === 'county' &&
                (!currentState || d.state === currentState)
            );
            
            const csv = 'County,State,Year,ALICE %,Poverty %,Combined %,Households\n' +
                filtered.map(d => 
                    `"${d.county}","${d.state}",${d.year},${d.aliceRate},${d.povertyRate},${d.combinedRate},${d.totalHouseholds}`
                ).join('\n');
            
            downloadFile(csv, 'alice-data.csv', 'text/csv');
        }
        
        function exportJSON() {
            const filtered = aliceData.filter(d => 
                d.year === currentYear && 
                d.geoLevel === 'county' &&
                (!currentState || d.state === currentState)
            );
            
            downloadFile(JSON.stringify(filtered, null, 2), 'alice-data.json', 'application/json');
        }
        
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Event listeners
        document.getElementById('yearSelect').addEventListener('change', e => {
            currentYear = parseInt(e.target.value);
            updateView();
        });
        
        document.getElementById('stateSelect').addEventListener('change', e => {
            currentState = e.target.value;
            currentCounty = '';
            updateCountyDropdown(currentState);
            updateView();
            
            // Zoom to state bounds if selected
            if (currentState && countyLayer) {
                const stateBounds = L.latLngBounds();
                let hasCounties = false;
                
                countyLayer.eachLayer(layer => {
                    const data = dataCache.get(`${layer.feature.properties.STATE}${layer.feature.properties.COUNTY}_${currentYear}`);
                    if (data && data.state === currentState) {
                        stateBounds.extend(layer.getBounds());
                        hasCounties = true;
                    }
                });
                
                if (hasCounties) {
                    map.fitBounds(stateBounds, { padding: [20, 20] });
                }
            } else {
                // Reset to full US view
                map.setView([39.8283, -98.5795], 4);
            }
        });
        
        document.getElementById('countySelect').addEventListener('change', e => {
            currentCounty = e.target.value;
            if (currentCounty) selectCounty(currentCounty);
            else updateView();
        });
        
        document.getElementById('searchInput').addEventListener('input', handleSearch);
        
        // View mode buttons
        document.querySelectorAll('.view-button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.view-button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentView = btn.dataset.view;
                updateView();
            });
        });
        
        // Initialize
        initMap();
        loadData();
    </script>
</body>
</html>