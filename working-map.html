<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALICE Data Explorer - Working Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .status {
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .controls {
            margin: 15px 0;
        }
        
        select, input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .data-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 15px;
        }
        
        .data-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .data-item:hover {
            background: #f5f5f5;
        }
        
        .data-item strong {
            color: #0066cc;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-box {
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #0066cc;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
        }
        
        button {
            width: 100%;
            padding: 10px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        button:hover {
            background: #0052a3;
        }
        
        .legend {
            margin-top: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #999;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="info-panel">
        <h2>ALICE Data Explorer</h2>
        
        <div id="status" class="status">
            Initializing map...
        </div>
        
        <div class="stats">
            <div class="stat-box">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">Total Records</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="stateCount">0</div>
                <div class="stat-label">States</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="countyCount">0</div>
                <div class="stat-label">Counties</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="avgRate">0%</div>
                <div class="stat-label">Avg Combined</div>
            </div>
        </div>
        
        <div class="controls">
            <input type="text" id="searchBox" placeholder="Search county or state...">
            
            <select id="stateFilter">
                <option value="">All States</option>
            </select>
            
            <select id="levelFilter">
                <option value="">All Levels</option>
                <option value="county">Counties Only</option>
                <option value="subcounty">Subcounties Only</option>
            </select>
            
            <button onclick="resetMap()">Reset View</button>
            <button onclick="loadSampleData()">Load Sample Data</button>
        </div>
        
        <div class="legend">
            <strong>Combined ALICE + Poverty Rate</strong>
            <div class="legend-item">
                <div class="legend-color" style="background: #00ff00;"></div>
                <span>&lt; 30% - Low</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ffff00;"></div>
                <span>30-40% - Moderate</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ff9900;"></div>
                <span>40-50% - High</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ff0000;"></div>
                <span>&gt; 50% - Critical</span>
            </div>
        </div>
        
        <div id="dataList" class="data-list"></div>
    </div>
    
    <script>
        // Initialize variables
        let map;
        let markers = L.layerGroup();
        let aliceData = [];
        
        // Initialize map first
        function initMap() {
            try {
                // Create map
                map = L.map('map').setView([39.8283, -98.5795], 4);
                
                // Add tile layer - using OpenStreetMap as most reliable
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);
                
                // Add marker layer
                markers.addTo(map);
                
                updateStatus('Map initialized successfully', 'success');
                
                // Try to load data
                loadALICEData();
                
            } catch (error) {
                updateStatus('Error initializing map: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        // Update status message
        function updateStatus(message, type = '') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
        }
        
        // Load ALICE data
        async function loadALICEData() {
            updateStatus('Loading ALICE data...');
            
            try {
                const response = await fetch('alice_master_database.json');
                if (!response.ok) {
                    throw new Error('Failed to load data file');
                }
                
                aliceData = await response.json();
                updateStatus(`Loaded ${aliceData.length.toLocaleString()} records`, 'success');
                
                // Update statistics
                updateStatistics();
                
                // Populate filters
                populateFilters();
                
                // Show first 100 records on map
                displayRecords(aliceData.slice(0, 100));
                
                // Show data list
                updateDataList(aliceData.slice(0, 20));
                
            } catch (error) {
                updateStatus('Could not load alice_master_database.json - using sample data', 'error');
                console.error(error);
                loadSampleData();
            }
        }
        
        // Load sample data if main data fails
        function loadSampleData() {
            // Sample data for demonstration
            aliceData = [
                {
                    geoID: "48201",
                    geoLevel: "county",
                    geoDisplayLabel: "Harris County, Texas",
                    state: "Texas",
                    county: "Harris",
                    totalHouseholds: 1600000,
                    povertyRate: "14.1",
                    aliceRate: "31.2",
                    combinedRate: "45.3",
                    lat: 29.7604,
                    lng: -95.3698
                },
                {
                    geoID: "17031",
                    geoLevel: "county",
                    geoDisplayLabel: "Cook County, Illinois",
                    state: "Illinois",
                    county: "Cook",
                    totalHouseholds: 2100000,
                    povertyRate: "13.5",
                    aliceRate: "28.9",
                    combinedRate: "42.4",
                    lat: 41.8781,
                    lng: -87.6298
                },
                {
                    geoID: "06037",
                    geoLevel: "county",
                    geoDisplayLabel: "Los Angeles County, California",
                    state: "California",
                    county: "Los Angeles",
                    totalHouseholds: 3400000,
                    povertyRate: "14.9",
                    aliceRate: "33.1",
                    combinedRate: "48.0",
                    lat: 34.0522,
                    lng: -118.2437
                },
                {
                    geoID: "36061",
                    geoLevel: "county",
                    geoDisplayLabel: "New York County, New York",
                    state: "New York",
                    county: "New York",
                    totalHouseholds: 760000,
                    povertyRate: "14.7",
                    aliceRate: "35.8",
                    combinedRate: "50.5",
                    lat: 40.7128,
                    lng: -74.0060
                },
                {
                    geoID: "12086",
                    geoLevel: "county",
                    geoDisplayLabel: "Miami-Dade County, Florida",
                    state: "Florida",
                    county: "Miami-Dade",
                    totalHouseholds: 950000,
                    povertyRate: "16.3",
                    aliceRate: "37.4",
                    combinedRate: "53.7",
                    lat: 25.7617,
                    lng: -80.1918
                }
            ];
            
            updateStatus('Using sample data (5 counties)', 'success');
            updateStatistics();
            populateFilters();
            displayRecords(aliceData);
            updateDataList(aliceData);
        }
        
        // Update statistics
        function updateStatistics() {
            const counties = aliceData.filter(d => d.geoLevel === 'county');
            const states = [...new Set(aliceData.map(d => d.state))];
            
            document.getElementById('totalCount').textContent = aliceData.length.toLocaleString();
            document.getElementById('stateCount').textContent = states.length;
            document.getElementById('countyCount').textContent = counties.length.toLocaleString();
            
            if (aliceData.length > 0) {
                const avgRate = aliceData.reduce((sum, d) => sum + parseFloat(d.combinedRate || 0), 0) / aliceData.length;
                document.getElementById('avgRate').textContent = avgRate.toFixed(1) + '%';
            }
        }
        
        // Populate filters
        function populateFilters() {
            const states = [...new Set(aliceData.map(d => d.state))].sort();
            const stateFilter = document.getElementById('stateFilter');
            
            stateFilter.innerHTML = '<option value="">All States</option>';
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateFilter.appendChild(option);
            });
            
            // Add event listeners
            stateFilter.addEventListener('change', filterData);
            document.getElementById('levelFilter').addEventListener('change', filterData);
            document.getElementById('searchBox').addEventListener('input', filterData);
        }
        
        // Display records on map
        function displayRecords(records) {
            // Clear existing markers
            markers.clearLayers();
            
            records.forEach(record => {
                // Use provided coordinates or estimate based on state
                let lat = record.lat;
                let lng = record.lng;
                
                if (!lat || !lng) {
                    // Use state center with randomization
                    const stateCoords = getStateCoordinates(record.state);
                    lat = stateCoords[0] + (Math.random() - 0.5) * 2;
                    lng = stateCoords[1] + (Math.random() - 0.5) * 2;
                }
                
                const color = getColor(parseFloat(record.combinedRate));
                
                const marker = L.circleMarker([lat, lng], {
                    radius: 8,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                marker.bindPopup(`
                    <strong>${record.geoDisplayLabel || record.county}</strong><br>
                    State: ${record.state}<br>
                    Poverty: ${record.povertyRate}%<br>
                    ALICE: ${record.aliceRate}%<br>
                    Combined: ${record.combinedRate}%<br>
                    Households: ${(record.totalHouseholds || 0).toLocaleString()}
                `);
                
                markers.addLayer(marker);
            });
            
            updateStatus(`Showing ${records.length} locations on map`, 'success');
        }
        
        // Get color based on rate
        function getColor(rate) {
            return rate > 50 ? '#ff0000' :
                   rate > 40 ? '#ff9900' :
                   rate > 30 ? '#ffff00' :
                   '#00ff00';
        }
        
        // Get state coordinates
        function getStateCoordinates(state) {
            const coords = {
                'Alabama': [32.806671, -86.791130],
                'Arkansas': [34.969704, -92.373123],
                'California': [36.778261, -119.417932],
                'Colorado': [39.059811, -105.311104],
                'Connecticut': [41.597782, -72.755371],
                'Delaware': [39.318523, -75.507141],
                'Florida': [27.766279, -81.686783],
                'Georgia': [33.040619, -83.643074],
                'Hawaii': [21.094318, -157.498337],
                'Idaho': [44.240459, -114.478828],
                'Illinois': [40.349457, -88.986137],
                'Indiana': [39.849426, -86.258278],
                'Iowa': [42.011539, -93.210526],
                'Kansas': [38.526600, -96.726486],
                'Louisiana': [31.169546, -91.867805],
                'Maine': [44.693947, -69.381927],
                'Maryland': [39.063946, -76.802101],
                'Michigan': [43.326618, -84.536095],
                'Minnesota': [45.694454, -93.900192],
                'Mississippi': [32.741646, -89.678696],
                'New Jersey': [40.298904, -74.521011],
                'New Mexico': [34.840515, -106.248482],
                'New York': [42.165726, -74.948051],
                'North Carolina': [35.630066, -79.806419],
                'Ohio': [40.388783, -82.764915],
                'Oregon': [43.804133, -120.554201],
                'Pennsylvania': [40.590752, -77.209755],
                'South Carolina': [33.856892, -80.945007],
                'Tennessee': [35.747845, -86.692345],
                'Texas': [31.054487, -97.563461],
                'Virginia': [37.769337, -78.169968],
                'Washington': [47.400902, -121.490494],
                'West Virginia': [38.491226, -80.954453]
            };
            
            return coords[state] || [39.8283, -98.5795]; // Default to US center
        }
        
        // Update data list
        function updateDataList(records) {
            const listDiv = document.getElementById('dataList');
            
            listDiv.innerHTML = '<strong>Data Records (click to view on map):</strong><br><br>' +
                records.map(r => `
                    <div class="data-item" onclick="focusOnLocation(${r.lat || 39}, ${r.lng || -98})">
                        <strong>${r.geoDisplayLabel || r.county}</strong><br>
                        ${r.state} | Combined: ${r.combinedRate}%
                    </div>
                `).join('');
        }
        
        // Focus on location
        function focusOnLocation(lat, lng) {
            map.setView([lat, lng], 8);
        }
        
        // Filter data
        function filterData() {
            const state = document.getElementById('stateFilter').value;
            const level = document.getElementById('levelFilter').value;
            const search = document.getElementById('searchBox').value.toLowerCase();
            
            let filtered = aliceData;
            
            if (state) {
                filtered = filtered.filter(d => d.state === state);
            }
            
            if (level) {
                filtered = filtered.filter(d => d.geoLevel === level);
            }
            
            if (search) {
                filtered = filtered.filter(d => 
                    (d.geoDisplayLabel && d.geoDisplayLabel.toLowerCase().includes(search)) ||
                    (d.county && d.county.toLowerCase().includes(search)) ||
                    (d.state && d.state.toLowerCase().includes(search))
                );
            }
            
            // Display filtered results (limit for performance)
            displayRecords(filtered.slice(0, 500));
            updateDataList(filtered.slice(0, 20));
        }
        
        // Reset map view
        function resetMap() {
            map.setView([39.8283, -98.5795], 4);
            filterData();
        }
        
        // Initialize when page loads
        window.onload = function() {
            initMap();
        };
    </script>
</body>
</html>