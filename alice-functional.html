<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALICE Data Explorer - Fully Functional</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f3f4f6;
            color: #1f2937;
        }
        
        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.5rem;
            color: #111827;
        }
        
        .header .subtitle {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .controls {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .control-group label {
            font-size: 0.875rem;
            color: #4b5563;
            font-weight: 500;
        }
        
        select, input[type="text"] {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            background: white;
            color: #111827;
        }
        
        input[type="text"] {
            width: 300px;
        }
        
        button {
            padding: 0.5rem 1rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            font-weight: 500;
        }
        
        button:hover {
            background: #2563eb;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 140px);
        }
        
        #map {
            flex: 1;
            background: #e5e7eb;
        }
        
        .sidebar {
            width: 400px;
            background: white;
            border-left: 1px solid #e5e7eb;
            overflow-y: auto;
            padding: 1.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .stat-card .label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .stat-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #111827;
            margin-top: 0.25rem;
        }
        
        .stat-card .change {
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        
        .data-table {
            margin-top: 2rem;
        }
        
        .data-table h3 {
            font-size: 1rem;
            color: #111827;
            margin-bottom: 1rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
        }
        
        td {
            padding: 0.5rem;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        .legend {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .legend h4 {
            margin: 0 0 10px 0;
            font-size: 0.875rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.75rem;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .chart-container {
            margin-top: 2rem;
            height: 200px;
        }
        
        .selected-info {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .selected-info h3 {
            color: #1e40af;
            margin-bottom: 0.5rem;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="loading" id="loader">
        <div>Loading ALICE Data...</div>
    </div>
    
    <div class="header">
        <div>
            <h1>ALICE Data Explorer</h1>
            <div class="subtitle">Asset Limited, Income Constrained, Employed Households</div>
        </div>
        <div id="data-status"></div>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <label>Year:</label>
            <select id="year-select">
                <!-- Will be populated dynamically -->
            </select>
        </div>
        
        <div class="control-group">
            <label>State:</label>
            <select id="state-select">
                <option value="">All States</option>
                <!-- Will be populated dynamically -->
            </select>
        </div>
        
        <div class="control-group">
            <label>Search:</label>
            <input type="text" id="search-input" placeholder="Search county or state...">
            <button onclick="performSearch()">Search</button>
        </div>
        
        <div class="control-group">
            <button onclick="resetView()">Reset View</button>
        </div>
    </div>
    
    <div class="main-container">
        <div id="map"></div>
        
        <div class="sidebar">
            <div id="selected-county" style="display: none;" class="selected-info"></div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="label">Counties Loaded</div>
                    <div class="value" id="counties-count">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">States with Data</div>
                    <div class="value" id="states-count">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">Avg ALICE Rate</div>
                    <div class="value" id="avg-alice">0%</div>
                </div>
                <div class="stat-card">
                    <div class="label">Avg Combined Rate</div>
                    <div class="value" id="avg-combined">0%</div>
                </div>
            </div>
            
            <div class="data-table">
                <h3>Top 10 Most Vulnerable Counties</h3>
                <table id="top-counties">
                    <thead>
                        <tr>
                            <th>County</th>
                            <th>State</th>
                            <th>Combined</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div class="chart-container">
                <canvas id="trend-chart"></canvas>
            </div>
        </div>
    </div>
    
    <script>
        let map;
        let countyLayer;
        let aliceData = [];
        let currentYear = 2023;
        let selectedState = '';
        let legend;
        let trendChart;
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([39.8282, -98.5795], 4);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap © CARTO',
                maxZoom: 19
            }).addTo(map);
            
            // Add legend
            legend = L.control({position: 'bottomright'});
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <h4>ALICE + Poverty Rate</h4>
                    <div class="legend-item"><div class="legend-color" style="background:#BD0026"></div> > 50%</div>
                    <div class="legend-item"><div class="legend-color" style="background:#E31A1C"></div> 40-50%</div>
                    <div class="legend-item"><div class="legend-color" style="background:#FC4E2A"></div> 30-40%</div>
                    <div class="legend-item"><div class="legend-color" style="background:#FD8D3C"></div> 20-30%</div>
                    <div class="legend-item"><div class="legend-color" style="background:#FEB24C"></div> 10-20%</div>
                    <div class="legend-item"><div class="legend-color" style="background:#FED976"></div> < 10%</div>
                `;
                return div;
            };
            legend.addTo(map);
        }
        
        // Load data
        async function loadData() {
            try {
                const response = await fetch('alice_master_database.json');
                aliceData = await response.json();
                
                document.getElementById('loader').style.display = 'none';
                document.getElementById('data-status').innerHTML = `
                    <span style="color: #10b981;">● ${aliceData.length.toLocaleString()} records loaded</span>
                `;
                
                populateControls();
                updateStatistics();
                loadCountyBoundaries();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loader').innerHTML = 'Error loading data. Please refresh.';
            }
        }
        
        // Populate dropdowns
        function populateControls() {
            // Get unique years
            const years = [...new Set(aliceData.map(d => d.year))].sort((a, b) => b - a);
            const yearSelect = document.getElementById('year-select');
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === 2023) option.selected = true;
                yearSelect.appendChild(option);
            });
            
            // Get unique states
            const states = [...new Set(aliceData.map(d => d.state))].filter(s => s).sort();
            const stateSelect = document.getElementById('state-select');
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateSelect.appendChild(option);
            });
            
            // Add event listeners
            yearSelect.addEventListener('change', (e) => {
                currentYear = parseInt(e.target.value);
                updateMap();
                updateStatistics();
            });
            
            stateSelect.addEventListener('change', (e) => {
                selectedState = e.target.value;
                updateMap();
                updateStatistics();
                if (selectedState) {
                    zoomToState(selectedState);
                }
            });
        }
        
        // Load county boundaries
        async function loadCountyBoundaries() {
            const response = await fetch('https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json');
            const geoData = await response.json();
            
            countyLayer = L.geoJSON(geoData, {
                style: style,
                onEachFeature: onEachFeature
            }).addTo(map);
        }
        
        // Style function
        function style(feature) {
            const geoID = feature.properties.GEOID;
            const data = getCountyData(geoID);
            
            return {
                fillColor: getColor(data ? parseFloat(data.combinedRate) : 0),
                weight: 0.5,
                opacity: 1,
                color: 'white',
                fillOpacity: data ? 0.7 : 0.1
            };
        }
        
        // Get color based on value
        function getColor(d) {
            return d > 50 ? '#BD0026' :
                   d > 40 ? '#E31A1C' :
                   d > 30 ? '#FC4E2A' :
                   d > 20 ? '#FD8D3C' :
                   d > 10 ? '#FEB24C' :
                            '#FED976';
        }
        
        // Get county data for current year and state
        function getCountyData(geoID) {
            return aliceData.find(d => 
                d.geoID === geoID && 
                d.year === currentYear && 
                d.geoLevel === 'county' &&
                (!selectedState || d.state === selectedState)
            );
        }
        
        // Feature handler
        function onEachFeature(feature, layer) {
            const geoID = feature.properties.GEOID;
            const data = getCountyData(geoID);
            
            if (data) {
                // Create popup
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0;">${data.county}, ${data.state}</h3>
                        <table style="width: 100%;">
                            <tr><td>Poverty Rate:</td><td style="text-align: right;"><strong>${data.povertyRate}%</strong></td></tr>
                            <tr><td>ALICE Rate:</td><td style="text-align: right;"><strong>${data.aliceRate}%</strong></td></tr>
                            <tr><td>Combined:</td><td style="text-align: right; color: #dc2626;"><strong>${data.combinedRate}%</strong></td></tr>
                            <tr><td>Total Households:</td><td style="text-align: right;">${data.totalHouseholds?.toLocaleString() || 'N/A'}</td></tr>
                        </table>
                    </div>
                `;
                layer.bindPopup(popupContent);
            }
            
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: selectCounty
            });
        }
        
        function highlightFeature(e) {
            const layer = e.target;
            layer.setStyle({
                weight: 2,
                color: '#666',
                fillOpacity: 0.9
            });
            layer.bringToFront();
        }
        
        function resetHighlight(e) {
            countyLayer.resetStyle(e.target);
        }
        
        function selectCounty(e) {
            const layer = e.target;
            const geoID = layer.feature.properties.GEOID;
            const data = getCountyData(geoID);
            
            if (data) {
                showCountyDetails(data);
                layer.openPopup();
            }
        }
        
        // Show county details in sidebar
        function showCountyDetails(data) {
            const detailsDiv = document.getElementById('selected-county');
            detailsDiv.style.display = 'block';
            detailsDiv.innerHTML = `
                <h3>${data.county}, ${data.state}</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <div>Poverty Rate: <strong style="color: #ef4444;">${data.povertyRate}%</strong></div>
                    <div>ALICE Rate: <strong style="color: #f59e0b;">${data.aliceRate}%</strong></div>
                    <div>Combined: <strong style="color: #dc2626;">${data.combinedRate}%</strong></div>
                    <div>Year: <strong>${data.year}</strong></div>
                </div>
                <div style="margin-top: 1rem;">
                    <div>Total Households: <strong>${data.totalHouseholds?.toLocaleString() || 'N/A'}</strong></div>
                    <div>Struggling: <strong>${((parseFloat(data.combinedRate) / 100) * data.totalHouseholds).toFixed(0).toLocaleString()}</strong></div>
                </div>
            `;
            
            // Load historical data for this county
            loadCountyTrend(data.geoID);
        }
        
        // Load trend for selected county
        function loadCountyTrend(geoID) {
            const countyHistory = aliceData.filter(d => 
                d.geoID === geoID && d.geoLevel === 'county'
            ).sort((a, b) => a.year - b.year);
            
            if (countyHistory.length > 1) {
                updateTrendChart(countyHistory);
            }
        }
        
        // Update trend chart
        function updateTrendChart(data) {
            const ctx = document.getElementById('trend-chart').getContext('2d');
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.year),
                    datasets: [
                        {
                            label: 'Poverty Rate',
                            data: data.map(d => parseFloat(d.povertyRate)),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'ALICE Rate',
                            data: data.map(d => parseFloat(d.aliceRate)),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'Combined Rate',
                            data: data.map(d => parseFloat(d.combinedRate)),
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Historical Trend'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        // Update statistics
        function updateStatistics() {
            const yearData = aliceData.filter(d => 
                d.year === currentYear && 
                d.geoLevel === 'county' &&
                (!selectedState || d.state === selectedState)
            );
            
            // Update counts
            document.getElementById('counties-count').textContent = yearData.length;
            
            const states = [...new Set(yearData.map(d => d.state))];
            document.getElementById('states-count').textContent = states.length;
            
            // Calculate averages
            const avgAlice = yearData.reduce((sum, d) => sum + parseFloat(d.aliceRate || 0), 0) / yearData.length;
            const avgCombined = yearData.reduce((sum, d) => sum + parseFloat(d.combinedRate || 0), 0) / yearData.length;
            
            document.getElementById('avg-alice').textContent = avgAlice.toFixed(1) + '%';
            document.getElementById('avg-combined').textContent = avgCombined.toFixed(1) + '%';
            
            // Update top counties table
            const topCounties = yearData
                .sort((a, b) => parseFloat(b.combinedRate) - parseFloat(a.combinedRate))
                .slice(0, 10);
            
            const tbody = document.querySelector('#top-counties tbody');
            tbody.innerHTML = topCounties.map(d => `
                <tr onclick="focusCounty('${d.geoID}')" style="cursor: pointer;">
                    <td>${d.county}</td>
                    <td>${d.state}</td>
                    <td><strong style="color: ${getColor(parseFloat(d.combinedRate))}">${d.combinedRate}%</strong></td>
                </tr>
            `).join('');
        }
        
        // Focus on specific county
        function focusCounty(geoID) {
            countyLayer.eachLayer(layer => {
                if (layer.feature && layer.feature.properties.GEOID === geoID) {
                    map.fitBounds(layer.getBounds());
                    layer.fire('click');
                }
            });
        }
        
        // Update map
        function updateMap() {
            if (countyLayer) {
                countyLayer.eachLayer(layer => {
                    const geoID = layer.feature.properties.GEOID;
                    const data = getCountyData(geoID);
                    
                    layer.setStyle({
                        fillColor: getColor(data ? parseFloat(data.combinedRate) : 0),
                        fillOpacity: data ? 0.7 : 0.1
                    });
                    
                    // Update popup
                    if (data) {
                        const popupContent = `
                            <div style="min-width: 200px;">
                                <h3 style="margin: 0 0 10px 0;">${data.county}, ${data.state}</h3>
                                <table style="width: 100%;">
                                    <tr><td>Poverty Rate:</td><td style="text-align: right;"><strong>${data.povertyRate}%</strong></td></tr>
                                    <tr><td>ALICE Rate:</td><td style="text-align: right;"><strong>${data.aliceRate}%</strong></td></tr>
                                    <tr><td>Combined:</td><td style="text-align: right; color: #dc2626;"><strong>${data.combinedRate}%</strong></td></tr>
                                    <tr><td>Total Households:</td><td style="text-align: right;">${data.totalHouseholds?.toLocaleString() || 'N/A'}</td></tr>
                                </table>
                            </div>
                        `;
                        layer.bindPopup(popupContent);
                    }
                });
            }
        }
        
        // Search functionality
        function performSearch() {
            const query = document.getElementById('search-input').value.toLowerCase();
            if (!query) return;
            
            const matches = aliceData.filter(d => 
                d.geoLevel === 'county' &&
                d.year === currentYear &&
                (d.county?.toLowerCase().includes(query) || d.state?.toLowerCase().includes(query))
            );
            
            if (matches.length > 0) {
                const first = matches[0];
                focusCounty(first.geoID);
            } else {
                alert('No matches found');
            }
        }
        
        // Zoom to state
        function zoomToState(stateName) {
            const stateCounties = aliceData.filter(d => 
                d.state === stateName && 
                d.geoLevel === 'county' &&
                d.year === currentYear
            );
            
            if (stateCounties.length > 0) {
                const bounds = [];
                countyLayer.eachLayer(layer => {
                    const geoID = layer.feature.properties.GEOID;
                    if (stateCounties.some(d => d.geoID === geoID)) {
                        bounds.push(layer.getBounds());
                    }
                });
                
                if (bounds.length > 0) {
                    const combinedBounds = bounds.reduce((acc, b) => acc.extend(b), bounds[0]);
                    map.fitBounds(combinedBounds);
                }
            }
        }
        
        // Reset view
        function resetView() {
            map.setView([39.8282, -98.5795], 4);
            document.getElementById('state-select').value = '';
            document.getElementById('search-input').value = '';
            document.getElementById('selected-county').style.display = 'none';
            selectedState = '';
            updateMap();
            updateStatistics();
        }
        
        // Initialize
        initMap();
        loadData();
        
        // Add enter key support for search
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    </script>
</body>
</html>