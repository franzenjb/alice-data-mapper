<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALICE Data Map - County & Subcounty Analysis</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #fff;
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        .control-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.95);
            border-radius: 10px;
            padding: 20px;
            width: 380px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        h1 {
            font-size: 1.5em;
            margin-bottom: 20px;
            background: linear-gradient(90deg, #00d4ff, #090979);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stats-container {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #888;
        }
        
        .stat-value {
            font-weight: bold;
            color: #00d4ff;
        }
        
        .search-container {
            margin-bottom: 20px;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid #333;
            border-radius: 5px;
            color: #fff;
            margin-bottom: 10px;
        }
        
        input::placeholder {
            color: #666;
        }
        
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
        }
        
        .search-item {
            padding: 10px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .search-item:hover {
            background: rgba(0,212,255,0.1);
        }
        
        .location-name {
            font-weight: bold;
            color: #fff;
        }
        
        .location-details {
            font-size: 0.85em;
            color: #888;
            margin-top: 3px;
        }
        
        .filter-section {
            margin: 20px 0;
            padding-top: 20px;
            border-top: 1px solid #333;
        }
        
        .filter-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #00d4ff;
        }
        
        .metric-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        .metric-btn {
            padding: 8px 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid #333;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .metric-btn:hover {
            background: rgba(0,212,255,0.2);
            border-color: #00d4ff;
        }
        
        .metric-btn.active {
            background: #00d4ff;
            color: #000;
            font-weight: bold;
        }
        
        .legend {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        
        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        
        .legend-color {
            width: 25px;
            height: 15px;
            margin-right: 10px;
            border-radius: 3px;
            border: 1px solid #fff;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
        }
        
        .error-message {
            background: rgba(255,0,0,0.2);
            border: 1px solid #ff0000;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .data-table {
            width: 100%;
            margin-top: 20px;
        }
        
        .data-table th,
        .data-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        
        .data-table th {
            color: #00d4ff;
        }
        
        .export-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(90deg, #00d4ff, #090979);
            border: none;
            border-radius: 5px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .export-btn:hover {
            opacity: 0.9;
        }
        
        /* Custom Leaflet popup styles */
        .leaflet-popup-content {
            color: #000;
            min-width: 250px;
        }
        
        .popup-header {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #090979;
        }
        
        .popup-stat {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="control-panel">
        <h1>ALICE Data Explorer</h1>
        
        <div class="stats-container">
            <div class="stat-row">
                <span class="stat-label">Total Records:</span>
                <span class="stat-value" id="totalRecords">Loading...</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Counties:</span>
                <span class="stat-value" id="countyCount">Loading...</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Subcounties:</span>
                <span class="stat-value" id="subcountyCount">Loading...</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">States:</span>
                <span class="stat-value" id="stateCount">32</span>
            </div>
        </div>
        
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search by county, city, or state...">
            <div id="searchResults" class="search-results"></div>
        </div>
        
        <div class="filter-section">
            <div class="filter-title">Geographic Level</div>
            <select id="geoFilter">
                <option value="all">All Levels</option>
                <option value="county">Counties Only</option>
                <option value="subcounty">Subcounties Only</option>
            </select>
        </div>
        
        <div class="filter-section">
            <div class="filter-title">State Filter</div>
            <select id="stateFilter">
                <option value="all">All States</option>
            </select>
        </div>
        
        <div class="filter-section">
            <div class="filter-title">Visualization Metric</div>
            <div class="metric-buttons">
                <button class="metric-btn active" data-metric="combined">Combined</button>
                <button class="metric-btn" data-metric="poverty">Poverty</button>
                <button class="metric-btn" data-metric="alice">ALICE</button>
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-title">Rate Ranges</div>
            <div class="legend-item">
                <div class="legend-color" style="background: #2ecc71;"></div>
                <span>&lt; 30% - Low</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f39c12;"></div>
                <span>30-40% - Moderate</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e67e22;"></div>
                <span>40-50% - High</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e74c3c;"></div>
                <span>&gt; 50% - Critical</span>
            </div>
        </div>
        
        <button class="export-btn" onclick="exportData()">Export Visible Data (CSV)</button>
    </div>
    
    <script>
        // Global variables
        let map;
        let markers = [];
        let aliceData = [];
        let filteredData = [];
        let currentMetric = 'combined';
        
        // State coordinates for mapping
        const stateCoordinates = {
            'Alabama': [32.806671, -86.791130],
            'Arkansas': [34.969704, -92.373123],
            'Colorado': [39.059811, -105.311104],
            'Connecticut': [41.597782, -72.755371],
            'Delaware': [39.318523, -75.507141],
            'Florida': [27.766279, -81.686783],
            'Georgia': [33.040619, -83.643074],
            'Hawaii': [21.094318, -157.498337],
            'Idaho': [44.240459, -114.478828],
            'Illinois': [40.349457, -88.986137],
            'Indiana': [39.849426, -86.258278],
            'Iowa': [42.011539, -93.210526],
            'Kansas': [38.526600, -96.726486],
            'Louisiana': [31.169546, -91.867805],
            'Maine': [44.693947, -69.381927],
            'Maryland': [39.063946, -76.802101],
            'Michigan': [43.326618, -84.536095],
            'Minnesota': [45.694454, -93.900192],
            'Mississippi': [32.741646, -89.678696],
            'New Jersey': [40.298904, -74.521011],
            'New Mexico': [34.840515, -106.248482],
            'New York': [42.165726, -74.948051],
            'North Carolina': [35.630066, -79.806419],
            'Ohio': [40.388783, -82.764915],
            'Oregon': [43.804133, -120.554201],
            'Pennsylvania': [40.590752, -77.209755],
            'South Carolina': [33.856892, -80.945007],
            'Tennessee': [35.747845, -86.692345],
            'Texas': [31.054487, -97.563461],
            'Virginia': [37.769337, -78.169968],
            'Washington': [47.400902, -121.490494],
            'West Virginia': [38.491226, -80.954453]
        };
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([39.8283, -98.5795], 5);
            
            // Dark theme tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap contributors © CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            
            loadData();
        }
        
        // Load ALICE data
        async function loadData() {
            try {
                const response = await fetch('alice_master_database.json');
                aliceData = await response.json();
                
                console.log(`Loaded ${aliceData.length} records`);
                
                // Update statistics
                updateStats();
                
                // Populate state filter
                populateStateFilter();
                
                // Display initial data (limited for performance)
                displayData(aliceData.slice(0, 2000));
                
                // Setup event listeners
                setupEventListeners();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.querySelector('.control-panel').innerHTML += 
                    '<div class="error-message">Error loading data. Please ensure alice_master_database.json is in the same directory.</div>';
            }
        }
        
        // Update statistics
        function updateStats() {
            const counties = aliceData.filter(d => d.geoLevel === 'county');
            const subcounties = aliceData.filter(d => d.geoLevel === 'subcounty');
            
            document.getElementById('totalRecords').textContent = aliceData.length.toLocaleString();
            document.getElementById('countyCount').textContent = counties.length.toLocaleString();
            document.getElementById('subcountyCount').textContent = subcounties.length.toLocaleString();
        }
        
        // Populate state filter
        function populateStateFilter() {
            const states = [...new Set(aliceData.map(d => d.state))].sort();
            const select = document.getElementById('stateFilter');
            
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                select.appendChild(option);
            });
        }
        
        // Display data on map
        function displayData(data) {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Add markers for each data point
            data.forEach(record => {
                // Get coordinates for the state
                const coords = stateCoordinates[record.state];
                if (!coords) return;
                
                // Add some randomization for subcounty locations within state
                let lat = coords[0];
                let lng = coords[1];
                
                if (record.geoLevel === 'subcounty') {
                    lat += (Math.random() - 0.5) * 2;
                    lng += (Math.random() - 0.5) * 2;
                }
                
                const color = getColorForRate(record[currentMetric + 'Rate']);
                
                const marker = L.circleMarker([lat, lng], {
                    radius: record.geoLevel === 'county' ? 8 : 5,
                    fillColor: color,
                    color: '#fff',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.7
                });
                
                // Create popup content
                const popupContent = `
                    <div class="popup-header">${record.geoDisplayLabel || record.county || 'Unknown'}</div>
                    <div class="popup-stat">
                        <span>GeoID:</span>
                        <strong>${record.geoID}</strong>
                    </div>
                    <div class="popup-stat">
                        <span>State:</span>
                        <strong>${record.state}</strong>
                    </div>
                    <div class="popup-stat">
                        <span>Level:</span>
                        <strong>${record.geoLevel}</strong>
                    </div>
                    <div class="popup-stat">
                        <span>Total Households:</span>
                        <strong>${(record.totalHouseholds || 0).toLocaleString()}</strong>
                    </div>
                    <div class="popup-stat">
                        <span>Poverty Rate:</span>
                        <strong>${record.povertyRate}%</strong>
                    </div>
                    <div class="popup-stat">
                        <span>ALICE Rate:</span>
                        <strong>${record.aliceRate}%</strong>
                    </div>
                    <div class="popup-stat">
                        <span>Combined Rate:</span>
                        <strong>${record.combinedRate}%</strong>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                marker.addTo(map);
                markers.push(marker);
            });
            
            filteredData = data;
        }
        
        // Get color based on rate
        function getColorForRate(rate) {
            const value = parseFloat(rate) || 0;
            if (value < 30) return '#2ecc71';
            if (value < 40) return '#f39c12';
            if (value < 50) return '#e67e22';
            return '#e74c3c';
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Search
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            
            // Filters
            document.getElementById('geoFilter').addEventListener('change', applyFilters);
            document.getElementById('stateFilter').addEventListener('change', applyFilters);
            
            // Metric buttons
            document.querySelectorAll('.metric-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.metric-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentMetric = this.dataset.metric;
                    displayData(filteredData);
                });
            });
        }
        
        // Handle search
        function handleSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            const resultsDiv = document.getElementById('searchResults');
            
            if (searchTerm.length < 2) {
                resultsDiv.innerHTML = '';
                return;
            }
            
            const results = aliceData.filter(d => 
                (d.geoDisplayLabel && d.geoDisplayLabel.toLowerCase().includes(searchTerm)) ||
                (d.county && d.county.toLowerCase().includes(searchTerm)) ||
                (d.state && d.state.toLowerCase().includes(searchTerm))
            ).slice(0, 10);
            
            resultsDiv.innerHTML = results.map(r => `
                <div class="search-item" onclick="focusLocation('${r.geoID}')">
                    <div class="location-name">${r.geoDisplayLabel || r.county || 'Unknown'}</div>
                    <div class="location-details">
                        ${r.state} | ${r.geoLevel} | Combined: ${r.combinedRate}%
                    </div>
                </div>
            `).join('');
        }
        
        // Apply filters
        function applyFilters() {
            const geoLevel = document.getElementById('geoFilter').value;
            const state = document.getElementById('stateFilter').value;
            
            let filtered = aliceData;
            
            if (geoLevel !== 'all') {
                filtered = filtered.filter(d => d.geoLevel === geoLevel);
            }
            
            if (state !== 'all') {
                filtered = filtered.filter(d => d.state === state);
            }
            
            // Limit to 2000 for performance
            displayData(filtered.slice(0, 2000));
            
            // Zoom to state if selected
            if (state !== 'all' && stateCoordinates[state]) {
                map.setView(stateCoordinates[state], 7);
            }
        }
        
        // Focus on location
        function focusLocation(geoID) {
            const location = aliceData.find(d => d.geoID === geoID);
            if (location && stateCoordinates[location.state]) {
                map.setView(stateCoordinates[location.state], 8);
            }
            document.getElementById('searchResults').innerHTML = '';
        }
        
        // Export data
        function exportData() {
            const headers = ['GeoID', 'Location', 'State', 'Level', 'Total Households', 'Poverty Rate', 'ALICE Rate', 'Combined Rate'];
            const rows = filteredData.map(d => [
                d.geoID,
                d.geoDisplayLabel || d.county || '',
                d.state,
                d.geoLevel,
                d.totalHouseholds,
                d.povertyRate,
                d.aliceRate,
                d.combinedRate
            ]);
            
            const csv = [
                headers.join(','),
                ...rows.map(row => row.map(val => `"${val}"`).join(','))
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `alice_data_${Date.now()}.csv`;
            a.click();
        }
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>